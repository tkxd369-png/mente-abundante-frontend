<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TMK — The Truth Path · Verificación</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="ebook-shell">

    <!-- TOPBAR -->
    <div class="ebook-topbar">
      <div class="brand">
        <div class="eyebrow">WebBook · TMK</div>
        <h1 class="title">
          <a href="index.html" class="book-link">Yo Decido Ser Abundante</a>
        </h1>
      </div>

      <!-- Dashboard link (tu CSS ya lo estiliza) -->
      <a href="../dashboard.html" class="ebook-dashboard-link">Dashboard</a>
    </div>

    <!-- READER CARD -->
    <section class="reader-card" id="reader">

      <!-- Sticky header -->
      <div class="reader-header sticky-head">
        <div class="sticky-row">
          <div class="kicker">✨ The Truth Path</div>
          <div class="pagecount" data-pagecount>Verificación</div>
        </div>

        <h1 class="reader-h1">Confirmación de comprensión</h1>
        <p class="reader-sub">No es un examen. Es una puerta de integración hacia un espacio personal: The Truth Path.</p>
      </div>

      <!-- Body -->
      <div class="reader-body">
        <div class="page">

          <p class="gold-note">
            “Mas tú, cuando ores, entra en tu aposento y cerrada la puerta…”<br>
            <span class="gold-aside">(Inspiración: un espacio íntimo de silencio, claridad y conexión real.)</span>
          </p>

          <p>Este sendero no se trata de religión, ni de dogmas de hombres, ni de misticismos, ni de manipulación.</p>
          <p>Se trata de una búsqueda honesta: encontrar la verdad más allá del ruido.</p>
          <p>Por eso esta verificación existe: para confirmar que el mensaje del libro fue comprendido, y así abrirte acceso a <span class="gold-aside">The Truth Path</span>.</p>

          <hr class="soft-divider">

          <!-- QUIZ -->
          <form id="quizForm" novalidate>

            <div class="gold-note" style="font-weight:600;">
              Instrucciones: elige la opción que mejor refleja el espíritu del libro.
            </div>

            <!-- Q1 -->
            <div class="quiz-card">
              <p><strong>1)</strong> La verdadera abundancia, según el libro, se reconoce principalmente por:</p>
              <label class="quiz-opt"><input type="radio" name="q1" value="A"> Tener más lujos que otros</label>
              <label class="quiz-opt"><input type="radio" name="q1" value="B"> No sentir miedo nunca</label>
              <label class="quiz-opt"><input type="radio" name="q1" value="C"> Paz, claridad y alineación interior que sostiene lo externo</label>
              <label class="quiz-opt"><input type="radio" name="q1" value="D"> Lograr reconocimiento público</label>
            </div>

            <!-- Q2 -->
            <div class="quiz-card">
              <p><strong>2)</strong> ¿Cuál afirmación resume mejor “ser una fuente”?</p>
              <label class="quiz-opt"><input type="radio" name="q2" value="A"> Depender de otros para estar bien</label>
              <label class="quiz-opt"><input type="radio" name="q2" value="B"> Controlar a los demás para que cambien</label>
              <label class="quiz-opt"><input type="radio" name="q2" value="C"> Tomar responsabilidad y generar valor desde tu interior hacia afuera</label>
              <label class="quiz-opt"><input type="radio" name="q2" value="D"> Evitar todo riesgo para no fallar</label>
            </div>

            <!-- Q3 -->
            <div class="quiz-card">
              <p><strong>3)</strong> La ley de causa y efecto se aplica en el libro de esta manera:</p>
              <label class="quiz-opt"><input type="radio" name="q3" value="A"> El destino ya está escrito y no se puede cambiar</label>
              <label class="quiz-opt"><input type="radio" name="q3" value="B"> Lo que piensas, dices y haces siembra una dirección que produce resultados</label>
              <label class="quiz-opt"><input type="radio" name="q3" value="C"> La suerte define lo que recibes</label>
              <label class="quiz-opt"><input type="radio" name="q3" value="D"> Solo el trabajo físico produce resultados</label>
            </div>

            <!-- Q4 -->
            <div class="quiz-card">
              <p><strong>4)</strong> “Sembrar” en el contexto del libro significa:</p>
              <label class="quiz-opt"><input type="radio" name="q4" value="A"> Dar únicamente cuando te sobra</label>
              <label class="quiz-opt"><input type="radio" name="q4" value="B"> Hacer una acción intencional que lleva vida/valor, aunque sea pequeña, con dirección clara</label>
              <label class="quiz-opt"><input type="radio" name="q4" value="C"> Esperar el momento perfecto para empezar</label>
              <label class="quiz-opt"><input type="radio" name="q4" value="D"> Probar muchas cosas al azar a ver cuál funciona</label>
            </div>

            <!-- Q5 -->
            <div class="quiz-card">
              <p><strong>5)</strong> ¿Qué papel cumple la gratitud en el proceso de abundancia?</p>
              <label class="quiz-opt"><input type="radio" name="q5" value="A"> Ignorar problemas y negar la realidad</label>
              <label class="quiz-opt"><input type="radio" name="q5" value="B"> Mantenerte alineado, ver con claridad, y sostener reconocimiento en el camino</label>
              <label class="quiz-opt"><input type="radio" name="q5" value="C"> Convencer al mundo de que eres bueno</label>
              <label class="quiz-opt"><input type="radio" name="q5" value="D"> Agradecer solo cuando todo ya salió perfecto</label>
            </div>

            <!-- Q6 -->
            <div class="quiz-card">
              <p><strong>6)</strong> ¿Cuál es la forma más fiel de compartir TMK según el espíritu del libro?</p>
              <label class="quiz-opt"><input type="radio" name="q6" value="A"> Presionar a todos para que entren</label>
              <label class="quiz-opt"><input type="radio" name="q6" value="B"> Vender por necesidad</label>
              <label class="quiz-opt"><input type="radio" name="q6" value="C"> Recomendar solo si genuinamente sientes que aporta valor real a alguien</label>
              <label class="quiz-opt"><input type="radio" name="q6" value="D"> Publicar por obligación todos los días</label>
            </div>

            <!-- Q7 -->
            <div class="quiz-card">
              <p><strong>7)</strong> Cuando el libro habla de “La Verdad que libera”, se refiere a:</p>
              <label class="quiz-opt"><input type="radio" name="q7" value="A"> Una ideología para discutir con otros</label>
              <label class="quiz-opt"><input type="radio" name="q7" value="B"> Un concepto religioso para imponerse</label>
              <label class="quiz-opt"><input type="radio" name="q7" value="C"> Una comprensión que se vuelve vida práctica y ordena tus decisiones desde adentro</label>
              <label class="quiz-opt"><input type="radio" name="q7" value="D"> Un secreto exclusivo solo para unos pocos</label>
            </div>

            <div id="quizMsg" class="quiz-msg" style="display:none;"></div>

            <div class="quiz-actions">
              <button id="submitBtn" class="quiz-btn primary" type="submit">Verificar y continuar</button>
              <button id="resetBtn" class="quiz-btn" type="button" style="display:none;">Reintentar</button>
            </div>

          </form>

          <div id="successBox" style="display:none; margin-top: 18px;">
            <p class="gold-note" style="margin-bottom:12px;">
              ✅ Verificación completada.<br>
              <span class="gold-aside">The Truth Path</span> ha sido desbloqueado en tu cuenta.
            </p>

            <div class="quiz-actions">
              <!-- Cambia este href cuando definas la ruta final del Truth Path -->
              <button class="quiz-btn primary" type="button" onclick="window.location.href='../dashboard.html'">
                Ir al Dashboard (Media) →
              </button>
            </div>
          </div>

        </div>
      </div>
    </section>
  </div>

  <!-- Bottom nav (aparece al final, como en el libro) -->
  <div class="ebook-bottomnav" id="ebookNav">
    <button class="navbtn" type="button" onclick="window.location.href='end.html'">
      ← Volver al final del libro
    </button>

    <button class="navbtn primary" type="button" onclick="document.getElementById('submitBtn').scrollIntoView({behavior:'smooth', block:'center'});">
      Verificar →
    </button>
  </div>

  <!-- TMK: protección ligera (si ya la usas en el ebook, mantenla aquí también) -->
  <script src="ebook-protect.js"></script>

  <script>
    // ---------- UI helpers (minimal, no rompe tu CSS) ----------
    (function addQuizStyles(){
      const css = `
        .quiz-card{
          border: 1px solid rgba(0,0,0,0.06);
          background: rgba(255,255,255,0.70);
          border-radius: 18px;
          padding: 14px 14px 10px;
          margin: 0 0 14px 0;
          box-shadow: 0 10px 26px rgba(0,0,0,0.04);
        }
        .quiz-opt{
          display: block;
          margin: 10px 0;
          cursor: pointer;
          color: rgba(18,16,14,0.82);
        }
        .quiz-opt input{
          margin-right: 10px;
          transform: translateY(1px);
        }
        .quiz-actions{
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
          align-items: center;
          margin-top: 10px;
        }
        .quiz-btn{
          border: 1px solid rgba(0,0,0,0.10);
          background: rgba(255,255,255,0.75);
          color: rgba(20,18,16,0.72);
          border-radius: 999px;
          padding: 8px 12px;
          font-size: 0.68rem;
          letter-spacing: 0.14em;
          text-transform: uppercase;
          cursor: pointer;
          white-space: nowrap;
        }
        .quiz-btn.primary{
          border: 1px solid rgba(0,0,0,0.08);
          background: linear-gradient(135deg, rgba(242,196,123,0.95), rgba(227,169,90,0.95));
          color: rgba(24,18,10,0.92);
        }
        .quiz-msg{
          margin: 14px 0 0;
          padding: 12px 12px;
          border-radius: 14px;
          border: 1px solid rgba(0,0,0,0.06);
          background: rgba(255,255,255,0.65);
        }
      `;
      const st = document.createElement("style");
      st.textContent = css;
      document.head.appendChild(st);
    })();

    // ---------- Bottom nav: SOLO cuando llegas al final ----------
    (function () {
      const nav = document.getElementById("ebookNav");
      if (!nav) return;

      let lastY = window.scrollY || 0;
      let lastDir = "down";
      let stopTimer = null;

      function hide() { nav.classList.remove("show"); }
      function show() { nav.classList.add("show"); }

      function atBottom(thresholdPx = 80) {
        const y = window.scrollY || 0;
        const h = window.innerHeight || 0;
        const docH = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
        return (y + h) >= (docH - thresholdPx);
      }

      hide();

      window.addEventListener("scroll", function () {
        const y = window.scrollY || 0;
        if (y > lastY) lastDir = "down";
        else if (y < lastY) lastDir = "up";

        hide();
        clearTimeout(stopTimer);
        stopTimer = setTimeout(function () {
          if (lastDir === "down" && atBottom()) show();
          else hide();
        }, 170);

        lastY = y;
      }, { passive: true });
    })();

    // ---------- Quiz logic ----------
    (function () {
      const ANSWERS = { q1:"C", q2:"C", q3:"B", q4:"B", q5:"B", q6:"C", q7:"C" };
      const TOTAL = 7;
      const PASS = 6; // recomendado 6/7

      const form = document.getElementById("quizForm");
      const msg = document.getElementById("quizMsg");
      const submitBtn = document.getElementById("submitBtn");
      const resetBtn = document.getElementById("resetBtn");
      const successBox = document.getElementById("successBox");

      function showMsg(text, ok){
        msg.style.display = "block";
        msg.innerHTML = ok
          ? `<strong>✅ Listo.</strong> ${text}`
          : `<strong>⚠️ Casi.</strong> ${text}`;
      }

      function setLockedUI(locked){
        submitBtn.disabled = locked;
        submitBtn.style.opacity = locked ? "0.65" : "1";
        submitBtn.style.cursor = locked ? "not-allowed" : "pointer";
      }

      function scoreQuiz(){
        let score = 0;
        const details = {};
        Object.keys(ANSWERS).forEach((q) => {
          const chosen = (new FormData(form).get(q) || "").toString();
          details[q] = chosen || null;
          if (chosen && chosen === ANSWERS[q]) score++;
        });
        return { score, details };
      }

      async function submitToBackend(payload){
        // Endpoint placeholder — cámbialo cuando definamos tu ruta real
        // Ej: const url = "https://tu-api.com/api/quiz/submit";
        const url = "/api/quiz/submit";
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(payload)
        });
        // Si el backend no existe aún, esto fallará y caerá al fallback.
        if (!res.ok) throw new Error("Backend not available");
        return await res.json();
      }

      function fallbackUnlock(score){
        // Fallback local (si el backend aún no está conectado)
        try {
          localStorage.setItem("tmk_book_completed", "true");
          localStorage.setItem("tmk_truth_path_unlocked", "true");
          localStorage.setItem("tmk_quiz_score", String(score));
          localStorage.setItem("tmk_quiz_passed_at", new Date().toISOString());
        } catch (e) {}
      }

      function onPassed(){
        setLockedUI(true);
        resetBtn.style.display = "none";
        msg.style.display = "none";
        successBox.style.display = "block";
        // scroll suave al mensaje
        successBox.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      function onFailed(score){
        successBox.style.display = "none";
        resetBtn.style.display = "inline-flex";
        showMsg(
          `Tu resultado fue <strong>${score}/${TOTAL}</strong>. Relee con calma donde sentiste más resistencia y vuelve a intentarlo.`,
          false
        );
        msg.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      resetBtn.addEventListener("click", function(){
        // Resetea radios
        form.reset();
        msg.style.display = "none";
        resetBtn.style.display = "none";
        successBox.style.display = "none";
        setLockedUI(false);
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        // Validate all answered
        const fd = new FormData(form);
        for (let i = 1; i <= TOTAL; i++){
          if (!fd.get("q"+i)){
            showMsg("Responde todas las preguntas para continuar.", false);
            return;
          }
        }

        const { score, details } = scoreQuiz();

        if (score < PASS) {
          onFailed(score);
          return;
        }

        // Passed
        showMsg(`Resultado: <strong>${score}/${TOTAL}</strong>. Confirmación completada.`, true);

        // Try backend first, fallback to localStorage if backend isn't ready yet
        try {
          setLockedUI(true);
          await submitToBackend({
            kind: "tmk_truth_path_quiz",
            score,
            total: TOTAL,
            passed: true,
            answers: details
          });
        } catch (err) {
          fallbackUnlock(score);
        }

        onPassed();
      });
    })();
  </script>

</body>
</html>
