<!doctype html>
<html lang="es-MX">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mente Abundante – Membresía</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="ma-body">
  <div class="main-shell">
    <div class="card single">
      <div class="card-left">
        <!-- LOGO + TITULO -->
        <div class="logo-row">
          <div class="logo-drop"></div>
          <div>
            <div class="logo-text-main">MENTE ABUNDANTE</div>
            <div class="logo-text-sub">Membresía privada</div>
          </div>
        </div>

        <h2>Activa tu acceso</h2>
        <p class="lead">
          La aportación única de <strong>$198 USD</strong> te da acceso al video principal
          de 30 minutos, al programa “Yo Decido Ser Abundante” y al sistema de referidos.
        </p>

        <p class="small-note">
          <strong>Importante:</strong> Es indispensable contar con un
          <strong>código de invitación</strong>. Sin él no es posible procesar el pago ni continuar.
        </p>

        <!-- FORMULARIO -->
        <form class="form" id="membershipForm">
          <div>
            <div class="label">Código de invitación</div>
            <input
              class="input"
              type="text"
              name="refCode"
              id="refCode"
              required
              placeholder="Ej. ANA824"
            />
          </div>

          <div>
            <div class="label">Nombre completo</div>
            <input
              class="input"
              type="text"
              name="fullName"
              id="fullName"
              required
              placeholder="Tu nombre y apellidos"
            />
          </div>

          <div>
            <div class="label">Correo electrónico</div>
            <input
              class="input"
              type="email"
              name="email"
              id="email"
              required
              placeholder="tucorreo@ejemplo.com"
            />
          </div>

          <div>
            <div class="label">Teléfono (WhatsApp)</div>
            <input
              class="input"
              type="tel"
              name="phone"
              id="phone"
              required
              placeholder="+1 (555) 123-4567"
            />
          </div>

          <div>
            <div class="label">País de residencia</div>
            <select id="country" name="country" class="input" required>
              <option value="">Selecciona tu país</option>
              <option value="US">Estados Unidos</option>
              <option value="MX">México</option>
              <option value="BR">Brasil</option>
              <option value="CL">Chile</option>
              <option value="CO">Colombia</option>
              <option value="PE">Perú</option>
              <option value="CA">Canadá</option>
            </select>
            <p id="countryMessage" class="small-note"></p>
          </div>

          <div style="margin-top: 0.5rem;">
            <label class="label" style="display: flex; align-items: flex-start; gap: 0.4rem;">
              <input
                type="checkbox"
                id="termsCheck"
                style="margin-top: 0.15rem;"
                required
              />
              <span class="small-note">
                Confirmo que comprendo que la membresía inicial es de
                <strong>$198 USD</strong> y que después del pago tendré acceso
                al video principal, al quiz de integración y a mi
                dashboard personal.
              </span>
            </label>
          </div>

          <button type="submit" class="btn btn-primary" id="payButton">
            Pagar $198 USD
          </button>

          <p class="small-note" id="membershipMessage"></p>
        </form>

        <p class="small-note">
          Si llegaste aquí por un <strong>código QR</strong>, tu código de invitación debería aparecer
          automáticamente. Si no lo ves, regresa con la persona que te invitó para obtener tu código.
        </p>

        <div class="button-row">
          <a href="index.html" class="btn btn-secondary">Volver al inicio</a>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPT: CONEXIÓN AL BACKEND -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("membershipForm");
      const msg = document.getElementById("membershipMessage");
      const countryMsg = document.getElementById("countryMessage");
      const refInput = document.getElementById("refCode");
      const payButton = document.getElementById("payButton");

      // Autollenar ?ref= de la URL o de localStorage
      const params = new URLSearchParams(window.location.search);
      const refFromUrl = params.get("ref");
      const refFromStorage = localStorage.getItem("ma_ref_code");
      const finalRef = refFromUrl || refFromStorage || "";

      if (finalRef) {
        refInput.value = finalRef.toUpperCase();
      }

      const allowedCountries = ["US", "MX", "BR", "CL", "CO", "PE", "CA"];

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        msg.textContent = "";
        countryMsg.textContent = "";

        const fullName = document.getElementById("fullName").value.trim();
        const email = document.getElementById("email").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const refCode = refInput.value.trim().toUpperCase();
        const country = document.getElementById("country").value;
        const termsCheck = document.getElementById("termsCheck").checked;

        if (!refCode) {
          msg.textContent = "Necesitas un código de invitación válido.";
          msg.style.color = "#b33434";
          return;
        }

        if (!termsCheck) {
          msg.textContent = "Debes aceptar los términos para continuar.";
          msg.style.color = "#b33434";
          return;
        }

        if (!allowedCountries.includes(country)) {
          countryMsg.textContent =
            "Lo sentimos, actualmente solo aceptamos ciertos países.";
          countryMsg.style.color = "#b33434";
          return;
        }

        msg.textContent = "Procesando... por favor espera.";
        msg.style.color = "#444";
        payButton.disabled = true;

        try {
          const response = await fetch(
            "https://mente-abundante-api-1.onrender.com/api/checkout/create",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                fullName,
                email,
                phone,
                refCode,
                country,
              }),
            }
          );

          const data = await response.json();

          if (!data.ok) {
            msg.textContent = data.error || "No se pudo iniciar el proceso.";
            msg.style.color = "#b33434";
            payButton.disabled = false;
            return;
          }

          // Redirección (por ahora a puente-video, luego será Stripe)
          window.location.href = data.checkoutUrl;
        } catch (err) {
          console.error(err);
          msg.textContent =
            "Error al conectar con el servidor. Intenta nuevamente.";
          msg.style.color = "#b33434";
          payButton.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
 
