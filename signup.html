 <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Crea tu cuenta privada ‚Äî The Master Key</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />

  <style>
    body.ma-signup {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "DM Sans", sans-serif;
      background-color: #f6f0e8;
      color: #3a2f25;
      display: flex;
      flex-direction: column;
    }

    .ma-signup-shell {
      max-width: 720px;
      width: 100%;
      margin: 0 auto;
      padding: 2.2rem 1.4rem 2.8rem;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* HEADER */
    .ma-signup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .ma-logo-block {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .ma-logo-tag {
      font-size: 0.75rem;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: #9b8570;
    }

    .ma-logo-title {
      font-family: "Playfair Display", "Times New Roman", serif;
      font-size: 1rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #3a2f25;
    }

    .ma-login-link {
      font-size: 0.85rem;
      color: #7a6650;
      text-decoration: none;
      border-radius: 999px;
      border: 1px solid rgba(123, 102, 80, 0.25);
      padding: 0.35rem 0.9rem;
      background-color: #fdf8f1;
    }
    .ma-login-link:hover {
      background-color: #f5e4cf;
    }

    /* CARD */
    .ma-signup-card {
      margin-top: 0.4rem;
      background-color: #fdf8f1;
      border-radius: 24px;
      border: 1px solid rgba(0, 0, 0, 0.04);
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.12);
      padding: 1.9rem 1.6rem 2.1rem;
    }

    .ma-signup-eyebrow {
      font-size: 0.78rem;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: #9b8570;
      margin-bottom: 0.6rem;
    }

    .ma-signup-title {
      font-family: "Playfair Display", "Times New Roman", serif;
      font-size: 1.6rem;
      line-height: 1.3;
      color: #3a2f25;
      margin-bottom: 0.5rem;
    }

    .ma-signup-sub {
      font-size: 0.95rem;
      color: #7a6650;
      margin-bottom: 1.4rem;
      max-width: 30rem;
    }

    .ma-signup-form {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 0.9rem 1rem;
    }

    .ma-form-field {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .ma-form-field-full {
      grid-column: 1 / -1;
    }

    .ma-form-label {
      font-size: 0.8rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #9b8570;
    }

    .ma-form-input {
      width: 100%;
      padding: 0.7rem 0.8rem;
      border-radius: 12px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      background-color: #fbf5ec;
      font-size: 0.9rem;
      color: #3a2f25;
      outline: none;
    }

    .ma-form-input::placeholder {
      color: #b39b7f;
    }

    .ma-form-input:focus {
      border-color: #e3a95a;
      box-shadow: 0 0 0 1px rgba(227, 169, 90, 0.24);
      background-color: #fffdf8;
    }

    .ma-form-input[readonly] {
      background-color: #f3ebdf;
      cursor: default;
    }

    .ma-password-wrap {
      position: relative;
      display: flex;
      align-items: center;
    }

    .ma-password-wrap .ma-form-input {
      padding-right: 2.4rem;
    }

    .ma-password-toggle {
      position: absolute;
      right: 0.6rem;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      color: #9b8570;
      padding: 0;
    }

    .ma-field-hint {
      font-size: 0.78rem;
      color: #97826b;
    }

    .ma-signup-ref {
      font-size: 0.82rem;
      color: #7a6650;
      margin-top: 0.4rem;
    }

    .ma-signup-error {
      grid-column: 1 / -1;
      min-height: 1.2rem;
      font-size: 0.8rem;
      color: #c04730;
      margin-top: 0.2rem;
    }

    .ma-signup-success {
      grid-column: 1 / -1;
      min-height: 1.2rem;
      font-size: 0.82rem;
      color: #2f7a4c;
      margin-top: 0.2rem;
    }

    .ma-signup-cta {
      grid-column: 1 / -1;
      margin-top: 0.8rem;
    }

    .ma-signup-btn {
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 0.9rem 1.5rem;
      font-size: 0.9rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      background: linear-gradient(135deg, #f2c47b, #e3a95a);
      color: #2c241b;
      cursor: pointer;
      box-shadow: 0 16px 46px rgba(226, 167, 90, 0.5);
    }

    .ma-signup-btn:hover {
      filter: brightness(1.03);
    }

    .ma-signup-footer {
      margin-top: 2.4rem;
      font-size: 0.8rem;
      color: #97826b;
      text-align: center;
    }

    .ma-signup-footer a {
      color: #7a6650;
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    @media (max-width: 720px) {
      .ma-signup-shell {
        padding: 1.9rem 1.1rem 2.2rem;
      }
      .ma-signup-card {
        padding: 1.7rem 1.4rem 1.9rem;
      }
      .ma-signup-form {
        grid-template-columns: minmax(0, 1fr);
      }
      .ma-form-field-full {
        grid-column: 1 / -1;
      }
    }
  </style>
</head>

<body class="ma-signup">
  <div class="ma-signup-shell">
    <!-- HEADER -->
    <header class="ma-signup-header">
      <div class="ma-logo-block">
        <span class="ma-logo-tag">Paso 5 ¬∑ Cuenta privada</span>
        <span class="ma-logo-title">The Master Key</span>
      </div>
      <a href="login.html" class="ma-login-link">Ingresar</a>
    </header>

    <!-- CARD -->
    <section class="ma-signup-card">
      <div class="ma-signup-eyebrow">Crear tu acceso</div>
      <h1 class="ma-signup-title">Tu espacio personal dentro de The Master Key.</h1>

      <p class="ma-signup-sub">
        Aqu√≠ crear√°s tu cuenta privada. Este acceso se usar√° para entrar a tu dashboard,
        ver tus materiales y recibir tu link personal de referidos dentro del Programa.
      </p>

      <form id="signupForm" class="ma-signup-form">
        <div class="ma-form-field ma-form-field-full">
          <label class="ma-form-label" for="fullName">Nombre completo</label>
          <input
            id="fullName"
            class="ma-form-input"
            type="text"
            placeholder="Como aparece en tus documentos"
            autocomplete="name"
          />
        </div>

        <div class="ma-form-field">
          <label class="ma-form-label" for="email">Email</label>
          <input
            id="email"
            class="ma-form-input"
            type="email"
            placeholder="tucorreo@ejemplo.com"
            autocomplete="email"
          />
        </div>

        <div class="ma-form-field">
          <label class="ma-form-label" for="phone">Tel√©fono / WhatsApp</label>
          <input
            id="phone"
            class="ma-form-input"
            type="tel"
            placeholder="+52 ..."
            autocomplete="tel"
          />
        </div>

        <div class="ma-form-field">
          <label class="ma-form-label" for="username">Usuario (opcional)</label>
          <input
            id="username"
            class="ma-form-input"
            type="text"
            placeholder="Si lo dejas vac√≠o, crearemos uno por ti"
            autocomplete="username"
          />
          <div class="ma-field-hint">
            Esto se usa para construir tu c√≥digo personal de referidos.
          </div>
        </div>

        <div class="ma-form-field">
          <label class="ma-form-label" for="password">Contrase√±a</label>
          <div class="ma-password-wrap">
            <input
              id="password"
              class="ma-form-input"
              type="password"
              placeholder="Crea una contrase√±a segura"
              autocomplete="new-password"
            />
            <button
              type="button"
              class="ma-password-toggle"
              data-target="password"
              aria-label="Mostrar u ocultar contrase√±a"
            >
              üëÅ
            </button>
          </div>
        </div>

        <div class="ma-form-field">
          <label class="ma-form-label" for="passwordConfirm">Confirmar contrase√±a</label>
          <div class="ma-password-wrap">
            <input
              id="passwordConfirm"
              class="ma-form-input"
              type="password"
              placeholder="Repite tu contrase√±a"
              autocomplete="new-password"
            />
            <button
              type="button"
              class="ma-password-toggle"
              data-target="passwordConfirm"
              aria-label="Mostrar u ocultar contrase√±a"
            >
              üëÅ
            </button>
          </div>
        </div>

        <div class="ma-form-field ma-form-field-full">
          <label class="ma-form-label" for="refCode">C√≥digo de invitaci√≥n</label>
          <input
            id="refCode"
            class="ma-form-input"
            type="text"
            readonly
          />
          <div id="refHint" class="ma-signup-ref"></div>
        </div>

        <div id="signupError" class="ma-signup-error"></div>
        <div id="signupSuccess" class="ma-signup-success"></div>

        <div class="ma-signup-cta">
          <button id="signupBtn" type="submit" class="ma-signup-btn">
            Crear mi cuenta
          </button>
        </div>
      </form>
    </section>

    <div class="ma-signup-footer">
      Si ya tienes una cuenta, puedes
      <a href="login.html">ingresar aqu√≠</a>.
    </div>
  </div>

  <script>
    (function () {
      // marcar idioma ES para el flujo actual
      try {
        localStorage.setItem("ma_lang", "es");
      } catch (e) {}

      const API_BASE = "https://mente-abundante-api-1.onrender.com";

      const fullNameInput = document.getElementById("fullName");
      const emailInput = document.getElementById("email");
      const phoneInput = document.getElementById("phone");
      const usernameInput = document.getElementById("username");
      const passwordInput = document.getElementById("password");
      const passwordConfirmInput = document.getElementById("passwordConfirm");
      const refInput = document.getElementById("refCode");
      const refHint = document.getElementById("refHint");
      const signupForm = document.getElementById("signupForm");
      const signupError = document.getElementById("signupError");
      const signupSuccess = document.getElementById("signupSuccess");
      const signupBtn = document.getElementById("signupBtn");

      // Prefill desde localStorage
      let refCode = "";
      try {
        const preName = localStorage.getItem("ma_pre_fullName");
        const preEmail = localStorage.getItem("ma_pre_email");
        const prePhone = localStorage.getItem("ma_pre_phone");
        const storedRef = localStorage.getItem("ma_ref_code");

        if (preName && fullNameInput) fullNameInput.value = preName;
        if (preEmail && emailInput) emailInput.value = preEmail;
        if (prePhone && phoneInput) phoneInput.value = prePhone;
        if (storedRef) refCode = storedRef;
      } catch (e) {
        // ignore
      }

      if (refInput) {
        refInput.value = refCode || "";
      }
      if (refHint) {
        if (refCode) {
          refHint.textContent =
            "El c√≥digo de invitaci√≥n de tu patrocinador quedar√° ligado a tu cuenta: " + refCode + ".";
        } else {
          refHint.textContent =
            "Si alguien te comparti√≥ este Programa, su c√≥digo se registra a trav√©s de su link personal.";
        }
      }

      function setError(msg) {
        if (signupError) signupError.textContent = msg || "";
        if (signupSuccess) signupSuccess.textContent = "";
      }

      function setSuccess(msg) {
        if (signupSuccess) signupSuccess.textContent = msg || "";
        if (signupError) signupError.textContent = "";
      }

      // toggle de ojito
      function setupPasswordToggles() {
        const toggles = document.querySelectorAll(".ma-password-toggle");
        toggles.forEach((btn) => {
          btn.addEventListener("click", () => {
            const targetId = btn.getAttribute("data-target");
            if (!targetId) return;
            const input = document.getElementById(targetId);
            if (!input) return;

            if (input.type === "password") {
              input.type = "text";
              btn.textContent = "üôà";
            } else {
              input.type = "password";
              btn.textContent = "üëÅ";
            }
          });
        });
      }

      setupPasswordToggles();

      async function createAccount(evt) {
        evt.preventDefault();
        setError("");
        setSuccess("");

        const fullName = (fullNameInput?.value || "").trim();
        const email = (emailInput?.value || "").trim();
        const phone = (phoneInput?.value || "").trim();
        const username = (usernameInput?.value || "").trim();
        const password = passwordInput?.value || "";
        const passwordConfirm = passwordConfirmInput?.value || "";
        const refCodeLocal = (refInput?.value || refCode || "").trim();

        if (!fullName || !email || !phone || !password) {
          setError("Por favor completa nombre, email, tel√©fono y contrase√±a.");
          return;
        }

        if (password.length < 8) {
          setError("Tu contrase√±a debe tener al menos 8 caracteres.");
          return;
        }

        if (password !== passwordConfirm) {
          setError("La contrase√±a y la confirmaci√≥n no coinciden.");
          return;
        }

        signupBtn.disabled = true;
        signupBtn.textContent = "Creando cuenta...";

        try {
          const res = await fetch(API_BASE + "/auth/create-account", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              fullName,
              email,
              phone,
              password,
              username: username || undefined,
              refCode: refCodeLocal || undefined
            })
          });

          if (!res.ok) {
            let msg = "Hubo un problema al crear tu cuenta. Intenta de nuevo.";
            try {
              const dataErr = await res.json();
              if (dataErr && dataErr.error) msg = dataErr.error;
            } catch (e) {
              // ignore
            }
            throw new Error(msg);
          }

          const data = await res.json();

          // Guardar token y usuario
          try {
            if (data.token) {
              localStorage.setItem("ma_token", data.token);
            }
            if (data.user) {
              localStorage.setItem("ma_user", JSON.stringify(data.user));
            }
          } catch (e) {
            // ignore
          }

          setSuccess("Cuenta creada correctamente. Entrando a tu dashboard...");

          setTimeout(function () {
            window.location.href = "dashboard.html";
          }, 900);
        } catch (err) {
          setError(err.message || "Error inesperado. Intenta de nuevo.");
        } finally {
          signupBtn.disabled = false;
          signupBtn.textContent = "Crear mi cuenta";
        }
      }

      if (signupForm) {
        signupForm.addEventListener("submit", createAccount);
      }
    })();
  </script>
</body>
</html>
